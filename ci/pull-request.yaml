steps:
  - id: docker-build-pulumi-cli
    name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "docker-pulumi-cli", "../pulumi"]

  - id: pulumi-preview
    name: "docker-pulumi-cli"
    entrypoint: "pulumi"
    args: ["preview"]
    secretEnv: ["PULUMI_ACCESS_TOKEN"]
    waitFor: ["docker-build-pulumi-cli"]

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/mySecret/versions/latest
      env: "PULUMI_ACCESS_TOKEN"
