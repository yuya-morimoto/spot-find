steps:
  # https://www.pulumi.com/docs/guides/continuous-delivery/google-cloud-build/
  - name: "gcr.io/cloud-builders/npm"
    entrypoint: /bin/sh
    args:
      - "-c"
      - "chmod +x *.sh && .ci/script/pulumi.sh"
    env:
      - "PULUMI_ACCESS_TOKEN=$$PULUMI_ACCESS_TOKEN"
      - "PROJECT_ID=$PROJECT_ID"
    secretEnv: ["PULUMI_ACCESS_TOKEN"]

  - id: pulumi-preview
    name: "docker-pulumi-cli"
    entrypoint: "pulumi"
    args: ["preview"]
    secretEnv: ["PULUMI_ACCESS_TOKEN"]
    waitFor: ["docker-build-pulumi-cli"]

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/PULUMI_ACCESS_TOKEN/versions/latest
      env: "PULUMI_ACCESS_TOKEN"
