steps:
  # https://www.pulumi.com/docs/guides/continuous-delivery/google-cloud-build/
  - id: pulumi-push
    name: "gcr.io/cloud-builders/npm"
    entrypoint: /bin/sh
    args:
      - "-c"
      - "chmod +x ./ci/script/pulumi.sh && ./ci/script/pulumi.sh up"
      - "ls -l > $BUILDER_OUTPUT/output"
    env:
      - "PROJECT_ID=$PROJECT_ID"
    secretEnv: ["PULUMI_ACCESS_TOKEN"]
options:
  logging: "CLOUD_LOGGING_ONLY"

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/PULUMI_ACCESS_TOKEN/versions/latest
      env: "PULUMI_ACCESS_TOKEN"
